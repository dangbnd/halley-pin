datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum JobStatus {
  queued
  processing
  done
  failed
}

/// Simple visibility flag for product fields.
/// (Used by admin UI; guests never receive admin-only fields in APIs.)
enum Visibility {
  public
  private
}

model Photo {
  id          String @id @default(cuid())

  // Cloudflare R2 object keys
  originalKey String?
  displayKey  String @unique
  thumbKey    String @unique

  width        Int
  height       Int
  title        String

  aiCategory   String?
  aiConfidence Float   @default(0)

  userCategory  String?
  finalCategory String  @default("uncategorized")

  adminNote       String?
  adminNotePublic Boolean @default(false)
  adminSourceUrl  String?

  /// Product/Business fields (admin-managed)
  active                Boolean    @default(true)
  priceBySize            String?
  priceVisibility        Visibility @default(public)
  description            String?
  descriptionVisibility  Visibility @default(public)

  tags     Tag[]
  job      ClassificationJob?
  comments Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([finalCategory])
  @@index([createdAt])
}

model Tag {
  id        String   @id @default(cuid())
  /// Stable key used in DB + URLs (no accents, lowercase, hyphen-separated).
  /// Backwards-compatible: stored in the existing "name" column.
  key       String   @unique @map("name")
  /// Human-readable label (can contain Vietnamese + spaces)
  label     String

  /// admin ordering + visibility
  order     Int      @default(0)
  isActive  Boolean  @default(true)

  photos    Photo[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([label])
  @@index([order])
  @@index([isActive])
}

model Comment {
  id         String   @id @default(cuid())
  photoId    String
  authorName String   @default("áº¨n danh")
  content    String
  createdAt  DateTime @default(now())

  photo      Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@index([photoId, createdAt])
}

model ClassificationJob {
  id         String    @id @default(cuid())
  photoId    String    @unique
  status     JobStatus @default(queued)
  attempts   Int       @default(0)
  lastError  String?
  lockedAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  photo      Photo     @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@index([status, lockedAt])
}

model Category {
  id        String   @id @default(cuid())

  /// slug/key used in URLs + stored in Photo.finalCategory/userCategory
  key       String   @unique
  label     String

  /// admin ordering + visibility
  order     Int      @default(0)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@index([isActive])
}
